```mermaid
---
title: Stripe Subscription flow
---
---
title: Stripe Subscription flow
---
graph TD
  A[ユーザーがサブスクリプションプランを選択] --> B{無料トライアルか?}
  B -->|はい| C[無料トライアル開始]
  B -->|いいえ| D[ユーザーが支払い情報を入力]
  D --> E[アプリケーションがStripe APIを使って顧客を作成]
  C --> F{無料トライアル終了}
  F -->|はい| D
  F -->|いいえ| G[無料トライアル継続]
  E --> H[アプリケーションがStripe APIを使ってサブスクリプションを作成]
  H --> I[Stripeが支払い処理を行い、結果をアプリケーションに返す]
  I --> J{支払いが成功したか?}
  J -->|はい| K[アプリケーションがユーザーのアカウントをアップグレード]
  J -->|いいえ| L[支払い失敗処理]
  K --> M[サブスクリプションの情報を保存]
  M --> N[定期的にStripe APIを使ってサブスクリプションの状態を確認]
  N --> O{サブスクリプションの状態に変更があったか?}
  O -->|はい| P{変更の種類は?}
  P -->|キャンセル| Q[Stripe APIを使ってサブスクリプションをキャンセル]
  P -->|プラン変更| R[Stripe APIを使ってサブスクリプションのプランを更新]
  P -->|支払い失敗| L
  Q --> S[アカウントの状態を更新]
  R --> S
  L --> T{一定期間支払い失敗が続いたか?}
  T -->|はい| U[自動的にサブスクリプションをキャンセル]
  T -->|いいえ| V[ユーザーにカード情報の更新を促す]
  U --> S
  V --> N
  O -->|いいえ| W{請求サイクルに応じた処理が必要か?}
  W -->|はい| X[請求日の計算と請求処理の実行]
  W -->|いいえ| N
  X --> N
  S --> N
  L --> Y{支払い期限が過ぎたか?}
  Y -->|はい| Z[顧客に督促メールを送信]
  Y -->|いいえ| N
  Z --> N
  U --> AA[自動キャンセル後、メールを送信]
  AA --> N
```
